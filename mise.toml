[tools]
go = "latest"

[tasks]
version = "./scripts/version.sh"

[tasks.build]
run = '''
#!/bin/bash
set -euo pipefail

# Get version information
VERSION=$(git describe --tags --always 2>/dev/null || echo "dev")
BUILD_NAME=$(./scripts/generate_name.sh)
BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
GO_VERSION=$(go version | awk '{print $3}')

echo "Building Mockingbird ${VERSION} '${BUILD_NAME}'..."

# Build with ldflags to inject version info
go build \
  -ldflags="-X main.Version=${VERSION} -X main.BuildName=${BUILD_NAME} -X main.BuildTime=${BUILD_TIME} -X main.CommitHash=${COMMIT_HASH} -X main.GoVersion=${GO_VERSION}" \
  -o mockingbird ./cmd/server

echo "‚úÖ Built: mockingbird ${VERSION} '${BUILD_NAME}'"
'''

[tasks.webui-build]
run='''
#!/bin/bash
set -euo pipefail
cd webui
npm run build
'''

[tasks.start]
depends = ["build","webui-build"]
run = "./mockingbird"

[tasks.docker-build]
depends = ["build", "webui-build"]
run = '''
#!/bin/bash
set -euo pipefail

# Get version information
VERSION=$(git describe --tags --always 2>/dev/null || echo "dev")
BUILD_NAME=$(./scripts/generate_name.sh)
BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
GO_VERSION=$(go version | awk '{print $3}')

echo "Building Docker image ${VERSION} '${BUILD_NAME}'..."

# Build Docker image with build args
docker build \
  --build-arg GIT_TAG="${VERSION}" \
  --build-arg BUILD_NAME="${BUILD_NAME}" \
  --build-arg BUILD_TIME="${BUILD_TIME}" \
  --build-arg COMMIT_HASH="${COMMIT_HASH}" \
  --build-arg GO_VERSION="${GO_VERSION}" \
  -t charleslobo77/mockingbird:${VERSION} \
  -t charleslobo77/mockingbird:latest \
  .

echo "‚úÖ Built Docker image: ${VERSION} '${BUILD_NAME}'"
'''

[tasks.docker-push]
depends = ["docker-build"]
run = '''
VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "dev")
echo "Pushing Docker image with tag: $VERSION"
docker push charleslobo77/mockingbird:$VERSION
docker push charleslobo77/mockingbird:latest
'''

[tasks.plugin-build]
description = "Build a plugin's UI (usage: mise run plugin-build <plugin-name>)"
run = '''
#!/bin/bash
set -euo pipefail

PLUGIN_NAME="${1:-}"
if [ -z "$PLUGIN_NAME" ]; then
  echo "Usage: mise run plugin-build <plugin-name>"
  echo "Available plugins:"
  ls -1 plugins/
  exit 1
fi

PLUGIN_DIR="plugins/${PLUGIN_NAME}"
if [ ! -d "$PLUGIN_DIR" ]; then
  echo "‚ùå Plugin '${PLUGIN_NAME}' not found in plugins/"
  exit 1
fi

if [ ! -d "$PLUGIN_DIR/ui" ]; then
  echo "‚ùå Plugin '${PLUGIN_NAME}' has no UI directory"
  exit 1
fi

echo "üì¶ Building ${PLUGIN_NAME} plugin UI..."
cd "$PLUGIN_DIR/ui"
npm run build
echo "‚úÖ Built ${PLUGIN_NAME} plugin UI"
'''

[tasks.plugin-deploy]
description = "Deploy plugin to ~/.config/mockingbird/plugins (usage: mise run plugin-deploy <plugin-name>)"
run = '''
#!/bin/bash
set -euo pipefail

PLUGIN_NAME="${1:-}"
if [ -z "$PLUGIN_NAME" ]; then
  echo "Usage: mise run plugin-deploy <plugin-name>"
  echo "Available plugins:"
  ls -1 plugins/
  exit 1
fi

PLUGIN_DIR="plugins/${PLUGIN_NAME}"
CONFIG_DIR="$HOME/.config/mockingbird/plugins/${PLUGIN_NAME}"

if [ ! -d "$PLUGIN_DIR" ]; then
  echo "‚ùå Plugin '${PLUGIN_NAME}' not found in plugins/"
  exit 1
fi

echo "üöÄ Deploying ${PLUGIN_NAME} plugin to ${CONFIG_DIR}..."

# Create config directory if it doesn't exist
mkdir -p "$CONFIG_DIR"

# Copy plugin.js
if [ -f "$PLUGIN_DIR/plugin.js" ]; then
  cp "$PLUGIN_DIR/plugin.js" "$CONFIG_DIR/plugin.js"
  echo "  ‚úì Copied plugin.js"
else
  echo "  ‚ö†Ô∏è  No plugin.js found"
fi

# Copy UI dist if it exists
if [ -d "$PLUGIN_DIR/ui/dist" ]; then
  mkdir -p "$CONFIG_DIR/ui/dist"
  cp -r "$PLUGIN_DIR/ui/dist/"* "$CONFIG_DIR/ui/dist/"
  echo "  ‚úì Copied UI ($(du -sh "$PLUGIN_DIR/ui/dist/component.js" | cut -f1))"
else
  echo "  ‚ÑπÔ∏è  No UI build found (skipping)"
fi

echo "‚úÖ Deployed ${PLUGIN_NAME} plugin"
'''

[tasks.plugin-update]
description = "Build and deploy a plugin (usage: mise run plugin-update <plugin-name>)"
run = '''
#!/bin/bash
set -euo pipefail

PLUGIN_NAME="${1:-}"
if [ -z "$PLUGIN_NAME" ]; then
  echo "Usage: mise run plugin-update <plugin-name>"
  echo "Available plugins:"
  ls -1 plugins/
  exit 1
fi

# Build if UI exists
if [ -d "plugins/${PLUGIN_NAME}/ui" ]; then
  mise run plugin-build "$PLUGIN_NAME"
fi

# Deploy
mise run plugin-deploy "$PLUGIN_NAME"

echo ""
echo "üéâ Plugin '${PLUGIN_NAME}' updated! Restart Mockingbird to load changes."
'''
